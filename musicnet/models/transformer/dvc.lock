schema: '2.0'
stages:
  preprocess:
    cmd: python ../../preprocessing/wav_specs_and_notes/preprocess.py
    deps:
    - path: ../../../data/MusicNet/musicnet/musicnet
      hash: md5
      md5: 00306b63ca8e52bf0bfc89063c3570a8.dir
      size: 21728897172
      nfiles: 660
    params:
      ../../../params.yaml:
        midi_to_wav.programs_whitelist:
        - 0
        wav_specs_and_notes:
          use_converted_midis: true
          preprocessor:
            chunk_size_sec: 10
            chunk_shift_sec: 5
            target_sr: 44100
            note_rounding: 0.01
            n_fft: 2205
            hop_length: 441
            min_hz: 0
            n_filters: 200
            unit: amplitude
          datasets:
            train:
              size: 0.8
              file_count: 30
            val:
              size: 0.2
              file_count: 10
    outs:
    - path: ../../../data/preprocessed/wav_specs_and_notes
      hash: md5
      md5: 1194046808f122bdd334856d656df3b7.dir
      size: 46198100210
      nfiles: 80
  train:
    cmd: python train.py
    deps:
    - path: ../../../data/preprocessed/wav_specs_and_notes
      hash: md5
      md5: 7588a2158ba7cea04a74c08c9b0346f5.dir
      size: 42995960210
      nfiles: 80
    params:
      ../../../params.yaml:
        midi_to_wav.programs_whitelist:
        - 0
        transformer:
          architecture: encoder-only
          dataset_size: 1.0
          d_model: 128
          num_layers: 4
          num_heads: 8
          dff: 512
          mha_dropout: 0.0
          input_dropout: 0.0
          batch_size: 8
          epochs: 100
          warmup_steps: 6435
          max_lr: 0.0002
        wav_specs_and_notes.preprocessor.n_filters: 200
        wav_specs_and_notes.use_converted_midis: true
    outs:
    - path: dvclive/metrics.json
      hash: md5
      md5: b7bcc73156deb3798d11cfeb9966c505
      size: 213
    - path: dvclive/plots
      hash: md5
      md5: 3183c812761d109ab9798babb643aa00.dir
      size: 8912
      nfiles: 4
    - path: model.keras
      hash: md5
      md5: af819151a53d18942dd3cb0d985fa037
      size: 33554361
    - path: model.weights.h5
      hash: md5
      md5: 4a6367fc61de4ba219d1ea7d08d4be57
      size: 33552344
  convert_midi:
    cmd: python ../../preprocessing/midi_to_wav/convert.py
    deps:
    - path: ../../../data/MusicNet/musicnet/musicnet
      hash: md5
      md5: 00306b63ca8e52bf0bfc89063c3570a8.dir
      size: 21728897172
      nfiles: 660
    params:
      ../../../params.yaml:
        midi_to_wav:
          programs_whitelist:
          - 0
    outs:
    - path: ../../../data/preprocessed/midi_to_wav
      hash: md5
      md5: 571fd315a074b0d47f9ff9848294a557.dir
      size: 11431428370
      nfiles: 336
